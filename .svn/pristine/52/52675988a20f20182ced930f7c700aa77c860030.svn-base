/*
*	表单验证
*   提交、编辑、删除操作 
*/
layui.define(["form","layer","table"],function(exports){
	var form=layui.form,
	table=layui.table,
	layer=layui.layer;
	//开关打开变1关闭变0
	form.on('switch', function(data) {
	    $(data.elem).attr('type', 'hidden').val(this.checked ? 1 : 0);
	});
  // 取消按钮直接关闭iframe窗口
  $(":reset").click(function(){ 
    var index = parent.layer.getFrameIndex(window.name);
    parent.layer.close(index);
  });
	form.verify({
	    username:function(v,item){
	      if(!/^[a-zA-Z0-9_-]{4,10}$/.test(v))
	      {
	        return "用户名必须是4-10位大写、小写、下划线组合组成!";
	      }
	    },
	    password:function(v,item){
	    	if($.trim(v).length<6 || $.trim(v).length>25)
	    	{
	        	return "密码必须为6-25位之间!";
	     	}
	    },
	    repwd:function(v,item){
	    	if($("#pwd").val()!==v)
	    	{
	    		return "两次输入密码不同!";
	    	}
	    },
	    newPassword:function(v,item){
	    	if(!$.trim(v)=="" && ($.trim(v).length<6 || $.trim(v).length>25))
	    	{
	        	return "密码必须为6-25位之间!";
	     	}
	    },
	    len:function(v,item){
        //取出最小最大限制
        var arr=$(item).attr('length').split(',');
        var left=arr[0];
        var right=arr[1];
	    	if(!$.trim(v)=="" && ($.trim(v).length<left || $.trim(v).length>right))
	    	{
	        	return "长度需在"+left+"-"+right+"位之间!";
	     	}
	    },
      req:function(v,item){
        if($.trim(v)=="")
        {
          return $(item).attr('error');
        }
      }
  	});

  	var formSub={
    /**
     * [表单提交参数]
     * @param  {[object]} obj [配置对象]
     * subBtnName 提交按钮的lay-filter
     * url        提交地址,不传默认为当前页
     * msg        成功后的提示信息、默认为‘添加成功’
     * refresh    0刷新本页,1刷新父页,2刷新后重载表格
     */
  		sub:function(option){
  			var c={
  				msg:"添加成功",
  				url:"#",
  				refresh:{ //重载表格并且关闭弹出框配置
            type:1,
            tableField:"",  //表格的layuifield字段
            reload:{},      //表格重载后请求的数据配置
          }
  			}
  			$.extend(c,option);
  			form.on('submit('+c.subBtnName+')', function(data){
          var $this = $(this);
          //防重复提交
          if($this.attr("lock")==1)
          {
            return false;
          }
          $this.attr("lock",1);
  				$.post(c.url,data.field,function(res){
  				    if(res.code==1)
  				    {
  				        layer.msg(c.msg, {
  				          icon: 1,
  				          time: 1000
  				        }, function(){
  				        	if(c.refresh.type==1)
  				        	{
  				        		window.parent.window.location.reload();
  				        	}if(c.refresh.type==2)
                    {
                      parent.layui.table.reload(c.refresh.tableField,c.refresh.reload);
                      parent.layer.closeAll();
                    }else{
  				        		window.location.reload();
  				        	}
  				        });     
  				    }else{
  				        layer.alert(res.message, {icon: 5});
                  $this.attr("lock",0);
  				    }
  				},'json').error(function(){
              layer.alert("服务器异常,请稍后重试",{icon: 5});
              $this.attr("lock",0);
          });  
  				return false; //阻止表单跳转。
  			});
  		},
  		/**
  		 * table中的启用禁用
  		 * switchBtnName [switch的lay-filter属性]
  		 * url           [提交地址]
  		 */
  		switch:function(option){
  			//switchBtnName,url
  			var c={}
  			$.extend(c,option);
  			//启用禁用
		    form.on('switch('+c.switchBtnName+')',function(data){
		    	var state=data.elem.checked;
		    	var id=$(this).attr('data-id');
		    	var layerMsg =layer.load(0, {shade:[0.3,'#000'],time: 3000});
		    	setTimeout(function(){
		    		$.post(c.url,{state:state,id:id},function(res){
		    		if(res.code==1)
			    		{
			    			layer.close(layerMsg);
			    		}else{
			    			layer.close(layerMsg);
			    			layer.alert(res.message, {icon: 5});
			    		}
			    	},'json');
		    	},200);
		    });
  		},
  		/**
  		 * 表格的编辑和删除
  		 * option [配置信息]
  		 * tableFilterName	表格fileter字段
  		 * editUrl		编辑提交的URL
  		 * delUrl			删除提交的URL
  		 * area 			大小不传 默认100%
  		 * fieldName	编辑和删除请求传送的字段的名称默认为id
  		 * forbidId     禁止删除的id
  		 * forbidMsg		禁止删除错误提示、配置forbidId后必须配置
  		 */
  		tableTool:function(option){
  			var c={
  				editUrl:"",
  				delUrl:"",
  				area:['100%','100%'],
  				fieldName:"id",
          closeInfo:true,
  				editSuccess:function(layero, index,obj){}
  			}
  			$.extend(c,option);
  			//表格中的编辑、删除
		    table.on('tool('+c.tableFilterName+')' ,function(obj){
		        switch(obj.event){
		            case 'edit':
		                var index = layui.layer.open({
		                    title : "编辑"+c.key,
		                    type : 2,
                        maxmin:true,
		                    content : c.editUrl+"/"+c.fieldName+"/"+obj.data.id,
		                    area : c.area,
		                    success:function(layero,index){
                          //关闭提示
                          if(c.closeInfo)
                          {
                            setTimeout(function(){
                                  layui.layer.tips('点击此处返回', '.layui-layer-setwin .layui-layer-close', {
                                      tips: 3
                                  });
                              },300)
                          }
		                    	//回调
		                    	c.editSuccess(layero,index,obj);
		                    }
		                })
		                window.sessionStorage.setItem("index",index);
        						//改变窗口大小时，重置弹窗的宽高，防止超出可视区域（如F12调出debug的操作）
        						$(window).on("resize",function(){
        							layui.layer.full(window.sessionStorage.getItem("index"));
        						})
		                break;
		            case 'del':
		            	if(c.forbidId && obj.data.id==c.forbidId)
		            	{
			                layer.alert(c.forbidMsg, {icon: 5});
			                return false;
		            	}
		                layer.confirm('确定删除此'+c.key+'吗', {icon: 2, title: '提示信息'}, function (index) {
		                    $.post(c.delUrl,{ id : obj.data.id },function(res){
		                        if(res.code==1)
		                        {
		                            layer.msg(res.message, {
		                              icon: 1,
		                              time: 1000
		                            }, function(){
		                               window.location.reload();     
		                            });     
		                        }else{
		                            layer.alert(res.message, {icon: 5});
		                        }
		                    },'json')
		                })
		                break;
		            default:     
		        };
		    }); 
  		},
  		/**
  		 * 页面的添加按钮触发
  		 * option    配置参数
  		 * title	   窗体名称 默认为‘添加’
  		 * url  	   打开的页面URL
  		 * area      窗体大小默认100%
  		 * closeInfo 默认要提示关闭
  		 * maxmin    是否可以放大缩小
  		 */
  		addBtn: function(option){
  			//title,url
  			var c={
  				title:"添加",
  				area:['100%','100%'],
  				closeInfo:true,
  				maxmin:true,
  			}
  			$.extend(c,option);
			//添加按钮
            var index = layui.layer.open({
                title : c.title,
                type : 2,
                content :c.url,
                area:c.area,
                maxmin : c.maxmin,
                success : function(layero, index){
                	//关闭提示
                	if(c.closeInfo)
                	{
                		setTimeout(function(){
	                        layui.layer.tips('点击此处返回', '.layui-layer-setwin .layui-layer-close', {
	                            tips: 3
	                        });
	                    },300)
                	}
                }
            })   
            window.sessionStorage.setItem("index",index);
      			//改变窗口大小时，重置弹窗的宽高，防止超出可视区域（如F12调出debug的操作）
      			$(window).on("resize",function(){
      				layui.layer.full(window.sessionStorage.getItem("index"));
      			})
  		},
  		/**
  		 * 编辑按钮点击触发
  		 * option   配置
  		 * area 		大小默认100%
  		 * key			用于标题名
  		 * closeInfo 	是否提示关闭
  		 * editSuccess  成功弹出后回调函数
  		 */
  		editBtn: function(option){
  			var c={
  				area:['100%','100%'],
  				closeInfo:true,
  				editSuccess:function(layero, index){}
  			}
  			$.extend(c,option);
  			var index = layui.layer.open({
                title : "编辑"+c.key,
                type : 2,
                content : c.url,
                area : c.area,
                success:function(layero,index){
                	if(c.closeInfo)
                	{
                		setTimeout(function(){
	                        layui.layer.tips('点击此处返回', '.layui-layer-setwin .layui-layer-close', {
	                            tips: 3
	                        });
	                    },300)
                	}
                	//回调
                	c.editSuccess(layero,index);
                }
            })
            window.sessionStorage.setItem("index",index);
			//改变窗口大小时，重置弹窗的宽高，防止超出可视区域（如F12调出debug的操作）
			$(window).on("resize",function(){
				layui.layer.full(window.sessionStorage.getItem("index"));
			})
  		},
  		/**
  		 * 删除按钮点击触发
  		 * option [配置]
  		 * c.data  ajax提交的对象,为了防止ajax空参数出错,默认传了一个method      
  		 * c.key			用于标题名
  		 */
  		delBtn: function(option){
  			var c={
  				data:{
  					method:"del"
  				}
  			}
  			//深度合并
  			$.extend(true,c,option);
  			layer.confirm('确定删除此'+c.key+'吗', {icon: 2, title: '提示信息'}, function (index) {
            $.post(c.url,c.data,function(res){
                if(res.code==1)
                {
                      layer.msg(res.message, {
                        icon: 1,
                        time: 1000
                      }, function(){
                         window.location.reload();     
                      });     
                }else{
                  layer.alert(res.message, {icon: 5});
                }
              },'json')
            })
  		},
      //角色添加编辑页面的顶级菜单全选
      roleAuthSelect:function(){
            form.on('checkbox(father)', function(data){
                if(data.elem.checked){
                    $(data.elem).parents(".permission-list").find('input').prop("checked", true);
                    form.render();
                }else{
                    $(data.elem).parents(".permission-list").find('input').prop("checked", false);
                    form.render();
                }
            });
        },
        //角色添加编辑页面的子菜单全选
        roleAuthChildSelect:function(){
            //子菜单全选反选
            form.on('checkbox(child)', function(data){
                var l =$(this).parents(".permission-list").find("input:checked").length;
                var l2=$(this).parents(".permission-list").find(".permission-list2 dd").find("input:checked").length;
                if(data.elem.checked){
                    $(data.elem).parents(".cl").find('input').prop("checked", true);
                    $(data.elem).parents(".permission-list").find('input').eq(0).prop("checked", true);
                    form.render();
                }else{
                    $(data.elem).parents(".cl").find('input').prop("checked", false);
                    form.render();   
                }
            });
        },
        //招聘的select切换显示额外表单
        zpSwitch:function(){
            form.on("select(category_id)",function(data){
              if(data.value==3)
              {
                $("#zp").show();
              }else{
                $("#zp").hide();
                $("#zp input").val("");
              }
            })
        },
        //轮播图上传的切换选项
        switchSlide:function(){
            form.on("select(type)",function(obj){
              var value=obj.value;
              var type={head:"图片大小：1920*600",phone:"图片大小：750*728",banner:"图片大小：400*860"};
              $(".layui-word-aux").html(type[value]);
            })
        }

  	}
	exports("formSub",formSub);
})
